{% extends "../base/base_admin.html" %}
{% block title %}Manage | Account {% endblock %}
{% load static %}
{% block styles %}
<link href='https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css' rel='stylesheet'>
<link href='https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css' rel='stylesheet'>
{% endblock %}
{% block content %}
<div class="container-fluid pb-4">
    <div class="row d-flex justify-content-between">
        <div class="col-auto">
            <h1>SWDO Account</h1>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#add_new_account"><i class="bx bx-plus"></i> Add Account</button>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-lg-6 mb-lg-0 mb-3 ">
            <div class="input-group search-keyword">
                <input type="text" name="keyword" id="keyword" placeholder="Search Name" class="form-control">
                <button class="btn btn-outline-secondary background-color-green" type="button"><i class='bx bx-search-alt'></i></button>
            </div>
        </div>
        <div class="form-group col-lg-6 mb-lg-0 mb-3 ">
            <select name="status" id="status" class="form-select me-md-2">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Not Active">Not Active</option>
            </select>
        </div>
    </div>

    <div class="pt-4">
        <table class="table table-striped nowrap" id="table-account" style="width:100%">
            <thead class="border-bottom border-dark border-2 border-opacity-50">
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Email</th>
                    <th scope="col">Region</th>
                    <th scope="col">Province</th>
                    <th scope="col">City</th>
                    <th scope="col">Status</th>
                    <th scope="col">Date Added</th>
                    <th class="text-center" scope="col">Manage</th>
                </tr>
            </thead>
            <tbody class="table-group-divider">
                {% for account in accounts %}
                    <tr>
                        <td>{{ account.name }}</td>
                        <td>{{ account.user.email }}</td>
                        <td>{{ account.region }}</td>
                        <td>{{ account.province }}</td>
                        <td>{{ account.city }}</td>
                        <td>{{ account.status }}</td>
                        <td>{{ account.user.date_joined }}</td>
                        <td class="text-center">
                            <button class="btn btn-outline-success edit-account-btn" role="button" data-account-id="{{ account.user.id }}">View</button>
                            <button class="btn btn-outline-danger delete-account-btn ms-lg-3" role="button" data-account-id="{{ account.user.id }}">Delete</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div><!--end of div of table-->
</div>
<!-- Add the toast container to your HTML, make sure it's placed in a suitable location -->
<div class="toast-container position-fixed top-0 end-0 p-3 text-light">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header text-dark" style="background-color:#899499;">
            <img src="{% static 'img/ecs-no-bg-2.png' %}" class="rounded me-2" alt="..." style="width:20px;">
            <strong class="me-auto text-dark">Success</strong>
            <small>Just Now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body text-dark">
        </div>
    </div>
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header text-dark" style="background-color:#899499;">
            <img src="{% static 'img/ecs-no-bg-2.png' %}" class="rounded me-2" alt="..." style="width:20px;">
            <strong class="me-auto text-dark">Error</strong>
            <small>Just Now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body text-dark">
        </div>
    </div>
</div>

<!-- Modal add  -->
<div class="modal fade" id="add_new_account" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Add SWDO Account</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form id="addAccountForm" method="POST">
                {% csrf_token %}
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="account_username" name="account_username" placeholder="name@example.com" >
                    <label for="account_username">Username</label>
                    <div id="account_usernameFeedback" class="invalid-feedback">
                        Username is already Taken.
                    </div>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                </div>
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="account_email" name="account_email" placeholder="name@example.com" >
                    <label for="account_email">Email</label>
                    <div id="account_emailFeedback" class="invalid-feedback">
                        Email is already Taken.
                    </div>
                    <div id="account_emailFeedback2" class="invalid-feedback">
                        Invalid email format.
                    </div>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="account_fname" name="account_fname" placeholder="name@example.com" >
                    <label for="account_fname">Name</label>
                </div>

                <div class="form-floating mb-3">
                    <select class="form-select" id="region" name="region">
                        <option>--Select Option--</option>
                        {% for region in default_regions %}
                            <option value="{{ region.name }}" data-code="{{ region.code }}">{{ region.name }}</option>
                        {% empty %}
                            <option>No data found</option>
                        {% endfor %}
                    </select>
                    <label for="victim_region">Region</label>
                </div>
                
                <div class="form-floating mb-3">
                    <select class="form-select" id="province" name="province" disabled>
                        <option value="">--Select Option--</option>
                    </select>
                    <label for="province">Province</label>
                </div>  

                <div class="form-floating mb-3">
                    <select class="form-select" id="city" name="city" disabled>
                        <option value="">--Select Option--</option>
                    </select>
                    <label for="city">City</label>
                    <div id="account_cityFeedback" class="invalid-feedback">
                        City already have an account.
                    </div>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                </div>

            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" id="addAccountBtn" disabled>Add New Account</button>
        </div>
      </div>
    </div>
</div>

<!-- Modal edit -->
<div class="modal fade" id="edit_law_enforcement_account" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Edit Account</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form id="editAccountForm" method="POST">
                {% csrf_token %}
                
                <input type="hidden" id="account_id" name="account_id" value="0">
                    
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="edit_account_fname" name="edit_account_fname" placeholder="name@example.com" >
                    <label for="edit_account_fname">Name</label>
                </div>
                    
                
                <div class="form-floating mb-3">
                    <select class="form-select" name="edit_status" id="edit_status">
                        <option value="Active">Active</option>
                        <option value="Not Active">Not Active</option>
                    </select>
                    <label for="edit_status">Status</label>
                </div>

                <div class="form-floating mb-3">
                    <select class="form-select" id="edit_region" name="edit_region">
                        <option>--Select Option--</option>
                    </select>
                    <label for="edit_region">Region</label>
                </div>
                
                <div class="form-floating mb-3">
                    <select class="form-select" id="edit_province" name="edit_province">
                        <option>--Select Option--</option>
                    </select>
                    <label for="edit_province">Province</label>
                </div>

                <div class="form-floating mb-3">
                    <select class="form-select" id="edit_city" name="edit_city" disabled>
                        <option value="">--Select Option--</option>
                    </select>
                    <label for="edit_city">City</label>
                    <div id="edit_account_cityFeedback" class="invalid-feedback">
                        City already have an account.
                    </div>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                </div>
              
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" id="saveAccountBtn">Save Account</button>
        </div>
      </div>
    </div>
</div>

<!-- Modal confirm delete  -->
<div class="modal fade" id="confirmAccountDelete" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this Account?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmAccountDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block scripts %}
<!-- <script src="{% static 'js/police-station-address.js' %}"></script> -->
<script>
    const csrf_token = '{{ csrf_token }}'
    $(document).ready(function() {
        $('#table-account').DataTable({
            dom: 'Brt <"bottom"lp>',
            responsive: true,
            fixedHeader: true,
            lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            //order: [[4, 'desc']],
            order: [[0, 'desc']],
            pageLength: 20,
        });

        // Your filter options and search functionality
        $('input#keyword').on('input', function(e){
            var status = $(this).val();
            $('#table-account').DataTable().columns([0]).search(status).draw();
        });
        $('select#status').on('change', function(e){
            var status = $(this).val();
            $('#table-account').DataTable().columns([2]).search(status).draw();
        });

        // Function to handle form submission
        $('#addAccountForm').submit(function(event) {
            event.preventDefault(); // Prevent default form submission
            
            $('#addAccountBtn').prop('disabled', true); // Disable the button to prevent multiple submissions
            $.ajax({
                url: '{% url "create SWDO account" %}',
                method: 'POST',
                data: $(this).serialize(), // Serialize form data
                success: function(response) {
                    if (response.success) {
                        // Display success message and reload page after 2 seconds
                        $('#successToast .toast-body').text(response.message);
                        $('#successToast').toast('show');
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    } else {
                        // Display error message
                        $('#errorToast .toast-body').text(response.message);
                        $('#errorToast').toast('show');
                    }
                    $('#addAccountBtn').prop('disabled', false); // Enable the button after submission
                },
                error: function(xhr, errmsg, err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                    $('#addAccountBtn').prop('disabled', false); // Enable the button after submission
                }
            });
        });

        $(document).on('click', '.edit-account-btn', function() {
            var accountId = $(this).data('account-id');
            $.ajax({
                url: '{% url "edit_SWDO_account" 0 %}'.replace('0', accountId),
                method: 'GET',
                success: async function(response) {
                    $('#account_id').val(response.account_id);
                    $('#edit_account_fname').val(response.name);
                    $('#edit_status').val(response.status);

                    // Populate regions
                    populateRegions('#edit_region', response.region);

                    // Populate provinces
                    if(response.region) {
                        await setGeoSelectForEdit(document.querySelector('#edit_province'), {
                            region: response.region,
                            action: 'province',
                            csrfmiddlewaretoken: csrf_token,
                        }, response.province);
                    }

                    // Populate cities for the selected province and set the selected city
                    if(response.province) {
                        await populateEditCities('#edit_city', response.province, response.city);
                    }

                    $('#edit_law_enforcement_account').modal('show');
                }
            });
        });

        $('#saveAccountBtn').on('click', function() {
            var formData = $('#editAccountForm').serialize();
            $('#saveAccountBtn').prop('disabled', true); // Disable the button to prevent multiple submissions
            // Get the accountId from the hidden input field
            var accountId = $('#account_id').val();
            console.log('Account Id:', accountId);
            console.log(accountId);
            $.ajax({
                url: '{% url "edit_SWDO_account" 0 %}'.replace('0', accountId),
                method: 'POST',
                data: formData,
                success: function(response) {
                    // Handle success response
                    console.log(response);
                    // Optionally, close the modal or show a success message
                    $('#edit_law_enforcement_account').modal('hide');
                    // Display success message and reload page after 2 seconds
                    $('#successToast .toast-body').text(response.message);
                    $('#successToast').toast('show');
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                    $('#saveAccountBtn').prop('disabled', false); // Enable the button after submission
                    // Refresh the page or update any UI as needed
                },
                error: function(xhr, status, error) {
                    // Handle error
                    console.error('Error:', error);
                    // Display error message
                    $('#errorToast .toast-body').text(response.message);
                    $('#errorToast').toast('show');
                     $('#saveAccountBtn').prop('disabled', false); // Enable the button after submission
                    // Optionally, show an error message to the user
                }
            });
        });

        // Attach click event listener to the Delete button
        $(document).on('click', '.delete-account-btn', function () {
            // Retrieve the account ID from the data-account-id attribute
            var accountId = $(this).data('account-id');

            // Set the account ID value in the modal confirmation button
            $('#confirmAccountDeleteBtn').data('account-id', accountId);

            // Open the confirmation modal
            $('#confirmAccountDelete').modal('show');
        });

        // Attach click event listener to the confirmation modal Delete button
        $('#confirmAccountDeleteBtn').on('click', function() {
            // Retrieve the account ID from the data-account-id attribute of the Delete button in the modal
            var accountId = $(this).data('account-id');
            
            // Send an AJAX request to delete the account
            $.ajax({
                url: '{% url "delete_account" %}',
                method: 'POST',
                data: {
                    account_id: accountId,
                    // Add any additional data if needed
                },
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}' // Include the CSRF token using Django's template syntax
                },
                success: function(response) {
                    // Handle success response
                    // Display success message and reload page after 2 seconds
                    $('#successToast .toast-body').text(response.message);
                    $('#successToast').toast('show');
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                },
                error: function(xhr, status, error) {
                    // Handle error
                    console.error('Error:', error);
                    // Display error message
                    $('#errorToast .toast-body').text(response.message);
                    $('#errorToast').toast('show');
                    // Optionally, show an error message to the user
                }
            });
        });


        // Attach the form submission function to the click event of the submit button
        $('#addAccountBtn').click(function() {
            $('#addAccountForm').submit(); // Trigger form submission when the button is clicked
        });

        $('#account_username, #account_email').on('blur', function() {
            var username = $('#account_username').val();
            var email = $('#account_email').val();
            var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (username && email) {

                if(!emailPattern.test(email)){
                    //check if email is valid format
                    
                    $('#account_email').addClass('is-invalid');
                    $('#account_email').removeClass('is-valid'); // Remove is-valid class
                    $('#account_emailFeedback2').show();
                    $('#account_emailFeedback.valid-feedback').hide(); // Hide valid feedback
                    $('#account_emailFeedback').hide();
                
                }else{
                    $.ajax({
                    type: 'GET',
                    url: '/check_username_email/',
                    data: {
                        'username': username,
                        'email': email
                    },
                        success: function(response) {
                            if (response.username_taken) {
                                $('#account_username').addClass('is-invalid');
                                $('#account_username').removeClass('is-valid'); // Remove is-valid class
                                $('#account_usernameFeedback').show();
                                $('#account_usernameFeedback.valid-feedback').hide(); // Hide valid feedback
                            } else {
                                $('#account_username').removeClass('is-invalid');
                                $('#account_username').addClass('is-valid'); // Add is-valid class
                                $('#account_usernameFeedback').hide();
                                $('#account_usernameFeedback.valid-feedback').show(); // Show valid feedback
                            }
                
                            if (response.email_taken) {
                                $('#account_email').addClass('is-invalid');
                                $('#account_email').removeClass('is-valid'); // Remove is-valid class
                                $('#account_emailFeedback').show();
                                $('#account_emailFeedback.valid-feedback').hide(); // Hide valid feedback
                            } else {
                                $('#account_email').removeClass('is-invalid');
                                $('#account_email').addClass('is-valid'); // Add is-valid class
                                $('#account_emailFeedback').hide();
                                $('#account_emailFeedback.valid-feedback').show(); // Show valid feedback
                            }
                
                            // Check if both username and email are valid
                            if (!$('#account_username').hasClass('is-invalid') && !$('#account_email').hasClass('is-invalid')) {
                                $('#addAccountBtn').removeAttr('disabled'); // Remove disabled attribute
                            } else {
                                $('#addAccountBtn').attr('disabled', 'disabled'); // Add disabled attribute
                            }
                        }
                    });
                }
                
            }
            
            
        });

    });

    //==

    function addAddressListener(formElement, formType, count = 0) {
        let region = null
        let province = null
        let city = null

        region = formElement.querySelector(`#region`)
        province = formElement.querySelector(`#province`)
        city = formElement.querySelector(`#city`) // Changed to querySelector for select element

        province.disabled = true
        city.disabled = true

        region.addEventListener('change', (e) => {
            console.log("region changed")
            const regionSelect = formElement.querySelector(`#region`);
            const regionNameRaw = regionSelect.value;
            const regionName = regionNameRaw.replace(/\s*\(.*?\)\s*/g, '').trim();
            if(regionName) {
                setGeoSelectPoliceStation(province, {
                    region: regionName,
                    action: 'province',
                    csrfmiddlewaretoken: csrf_token,
                });
                province.disabled = false
                console.log("enabled province")
                
                // Clear cities when region changes
                city.innerHTML = '<option value="">--Select Option--</option>';
                city.disabled = true;
            } else {
                console.log('Please select a region.');
            }
        })

        province.addEventListener('change', (e) => {
            const provinceName = e.target.value;
            if (provinceName) {
                // Fetch cities for selected province
                fetchCitiesByProvince(provinceName, city);
                console.log("fetching cities for province:", provinceName)
            } else {
                console.log('Please select a province.');
                city.innerHTML = '<option value="">--Select Option--</option>';
                city.disabled = true;
            }
        });
        
        // Update city validation to work with select dropdown
        $(city).on('change', function() {
            const cityName = $(this).val();
            console.log("city changed: ", cityName);
            if(cityName){
                city_have_an_acc = is_city_have_an_account(cityName)
                console.log(city_have_an_acc)
                if(city_have_an_acc){
                    console.log("city has an account")
                    $(city).addClass('is-invalid');
                    $(city).removeClass('is-valid');
                    $('#account_cityFeedback').show();
                    $('#account_cityFeedback.valid-feedback').hide();
                    $('#addAccountBtn').attr('disabled', 'disabled');
                }else{
                    console.log("city do not have an account")
                    $(city).removeClass('is-invalid');
                    $(city).addClass('is-valid');
                    $('#account_cityFeedback').hide();
                    $('#account_cityFeedback.valid-feedback').show();
                    if (!$('#account_username').hasClass('is-invalid') && !$('#account_email').hasClass('is-invalid')) {
                        $('#addAccountBtn').removeAttr('disabled');
                    }
                }
            } else {
                // Clear validation when no city selected
                $(city).removeClass('is-invalid is-valid');
                $('#account_cityFeedback').hide();
                $('#account_cityFeedback.valid-feedback').hide();
            }
        });
    }
    
    function editAddressListener(formElement, formType, count = 0) {
        let region = formElement.querySelector(`#edit_region`)
        let province = formElement.querySelector(`#edit_province`)
        let city = formElement.querySelector(`#edit_city`) // Changed to querySelector

        if(region){
            region.addEventListener('change', (e) => {
                const regionName = e.target.value;
                if(regionName) {
                    setGeoSelectPoliceStation(province, {
                        region: regionName,
                        action: 'province',
                        csrfmiddlewaretoken: csrf_token,
                    });
                    province.disabled = false;
                    
                    // Clear cities when region changes
                    city.innerHTML = '<option value="">--Select Option--</option>';
                    city.disabled = true;
                } else {
                    console.log('Please select a region.');
                }
            })
        }

        if(province){
            province.addEventListener('change', (e) => {
                const provinceName = e.target.value;
                if (provinceName) {
                    // Fetch cities for selected province
                    fetchCitiesByProvince(provinceName, city);
                    console.log("fetching cities for province:", provinceName)
                } else {
                    console.log('Please select a province.');
                    city.innerHTML = '<option value="">--Select Option--</option>';
                    city.disabled = true;
                }
            });
        }

        $(city).on('change', function() {
            const cityName = $(this).val();
            console.log("city changed: ", cityName);
            if(cityName){
                city_have_an_acc = is_city_have_an_account(cityName)
                console.log(city_have_an_acc)
                if(city_have_an_acc){
                    console.log("city has an account")
                    $(city).addClass('is-invalid');
                    $(city).removeClass('is-valid');
                    $('#edit_account_cityFeedback').show();
                    $('#edit_account_cityFeedback.valid-feedback').hide();
                    $('#saveAccountBtn').attr('disabled', 'disabled');
                }else{
                    console.log("city do not have an account")
                    $(city).removeClass('is-invalid');
                    $(city).addClass('is-valid');
                    $('#edit_account_cityFeedback').hide();
                    $('#edit_account_cityFeedback.valid-feedback').show();
                    $('#saveAccountBtn').removeAttr('disabled');
                }
            } else {
                // Clear validation when no city selected
                $(city).removeClass('is-invalid is-valid');
                $('#edit_account_cityFeedback').hide();
                $('#edit_account_cityFeedback.valid-feedback').hide();
            }
        });
    }

    //==
    document.addEventListener('DOMContentLoaded', () => {
        addAddressListener(document.querySelector('#addAccountForm'), 'account')
        editAddressListener(document.querySelector('#editAccountForm'), 'edit_account')
    })
    
    function is_city_have_an_account(city){
        let has_account = false;
        $.ajax({
            url: '{% url "acc city" %}',
            method: 'GET',
            async: false, // Make the request synchronous
            data: {
                'city': city
            },
            success: function(response) {
                has_account = response.city_taken;
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
        return has_account;
    }
    async function setGeoSelectPoliceStation(selectElement, formData) {
        try {
            const res = await fetch('/pages/get-police-station/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrf_token
                },
                body: new URLSearchParams(formData)
            });

            if (!res.ok) throw new Error(`Server error: ${res.status}`);
            const data = await res.json();

            selectElement.innerHTML = '';
            const blankOption = document.createElement('option');
            blankOption.textContent = '--Select Option--';
            blankOption.value = '';
            selectElement.appendChild(blankOption);

            data.forEach(item => {
                if(item.name === "ZAMBOANGA CITY") return; // Skip "Not Applicable"
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name;
                selectElement.appendChild(option);
                console.log(item.name);
            });
        } catch (error) {
            console.error("Failed to fetch Province:", error);
        }
    }

    async function setGeoSelect(geoTypeInput, formData) {

        const res = await fetch('/pages/select-address/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf_token
            },
            body: JSON.stringify(formData),
        })

        const data = await res.json()

        const blankOption = document.createElement('option')
        blankOption.textContent = '--Select Option--'
        blankOption.value = ''
        // clear all options in select element
        geoTypeInput.replaceChildren()

        // apend blank option as the first selected options
        geoTypeInput.appendChild(blankOption)
        // apped data to respective inputs
        data.forEach(item => {
            const option = document.createElement('option')
            option.dataset.code = item.code
            option.value = item.name
            option.textContent = item.name
            geoTypeInput.appendChild(option)
        })
    }
    async function setGeoSelectForEdit(selectElement, formData, selectedValue = '') {
        try {
            const res = await fetch('/pages/get-police-station/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrf_token
                },
                body: new URLSearchParams(formData)
            });

            if (!res.ok) throw new Error(`Server error: ${res.status}`);
            const data = await res.json();

            selectElement.innerHTML = '';
            const blankOption = document.createElement('option');
            blankOption.textContent = '--Select Option--';
            blankOption.value = '';
            selectElement.appendChild(blankOption);

            data.forEach(item => {
                 if(item.name === "ZAMBOANGA CITY") return; // Skip "Not Applicable"
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name;
                if (item.name === selectedValue) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        } catch (error) {
            console.error("Failed to fetch data:", error);
        }
    }

    function populateRegions(selectId, selectedValue = '') {
        // You can either fetch regions dynamically or use the default regions
        $(selectId).empty();
        $(selectId).append('<option value="">--Select Option--</option>');
        
        // Add your regions here (you might want to fetch this from the backend)
        {% for region in default_regions %}
            var selected = '{{ region.name }}' === selectedValue ? 'selected' : '';
            $(selectId).append(`<option value="{{ region.name }}" ${selected}>{{ region.name }}</option>`);
        {% endfor %}
    }

    function populateProvinces(selectId, regionName, selectedValue = '') {
        if (!regionName) return;
        
        // Clear provinces and cities
        $(selectId).empty();
        $(selectId).append('<option value="">--Select Option--</option>');
        $('#edit_city').empty().append('<option value="">--Select Option--</option>').prop('disabled', true);
        
        // Fetch provinces for the selected region
        setGeoSelectForEdit(document.querySelector(selectId), {
            region: regionName,
            action: 'province',
            csrfmiddlewaretoken: csrf_token,
        }, selectedValue);
    }
    
    async function fetchCitiesByProvince(provinceName, selectElement) {
        try {
            // First get the province ID using the dedicated endpoint
            const provinceResponse = await fetch('{% url "get province id" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrf_token
                },
                body: new URLSearchParams({
                    'province_name': provinceName,
                    'csrfmiddlewaretoken': csrf_token,
                })
            });
            
            const provinceData = await provinceResponse.json();
            
            if (provinceData.success) {
                const provinceId = provinceData.province_id;
                
                // Now fetch cities using the province ID
                const cityResponse = await fetch(`{% url 'get city by province' 0 %}`.replace('0', provinceId), {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrf_token
                    }
                });
                
                const cityData = await cityResponse.json();
                
                // Clear existing options
                selectElement.innerHTML = '';
                const blankOption = document.createElement('option');
                blankOption.textContent = '--Select Option--';
                blankOption.value = '';
                selectElement.appendChild(blankOption);
                
                // Add cities to dropdown
                cityData.city_list.forEach(cityName => {
                    const option = document.createElement('option');
                    option.value = cityName;
                    option.textContent = cityName;
                    selectElement.appendChild(option);
                });
                
                selectElement.disabled = false;
                console.log(`Loaded ${cityData.city_list.length} cities for province: ${provinceName}`);
                
            } else {
                console.error('Province not found:', provinceData.error);
                selectElement.innerHTML = '<option value="">Province not found</option>';
                selectElement.disabled = true;
            }
            
        } catch (error) {
            console.error("Failed to fetch cities:", error);
            selectElement.innerHTML = '<option value="">Error loading cities</option>';
            selectElement.disabled = true;
        }
    }

    async function populateEditCities(selectId, provinceName, selectedCity = '') {
        const selectElement = document.querySelector(selectId);

        // Get province ID
        const provinceResponse = await fetch('{% url "get province id" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrf_token
            },
            body: new URLSearchParams({
                'province_name': provinceName,
                'csrfmiddlewaretoken': csrf_token,
            })
        });
        const provinceData = await provinceResponse.json();

        if (provinceData.success) {
            const provinceId = provinceData.province_id;

            // Get cities by province ID
            const cityResponse = await fetch(`{% url 'get city by province' 0 %}`.replace('0', provinceId), {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrf_token
                }
            });
            const cityData = await cityResponse.json();

            // Populate city dropdown
            selectElement.innerHTML = '';
            const blankOption = document.createElement('option');
            blankOption.textContent = '--Select Option--';
            blankOption.value = '';
            selectElement.appendChild(blankOption);

            cityData.city_list.forEach(cityName => {
                const option = document.createElement('option');
                option.value = cityName;
                option.textContent = cityName;
                if (cityName === selectedCity) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });

            selectElement.disabled = false;
        } else {
            selectElement.innerHTML = '<option value="">Province not found</option>';
            selectElement.disabled = true;
        }
    }

</script>
{% endblock scripts %}